generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  PATIENT
  PROVIDER
  ADMIN
}

enum RecordType {
  MRI
  XRAY
  ULTRASOUND
  CT_SCAN
  OTHER
}

enum Permission {
  VIEW
  DOWNLOAD
}

enum FollowUpStatus {
  PENDING
  SCHEDULED
  COMPLETED
  OVERDUE
}

enum OrgRole {
  OWNER
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  password        String
  name            String?
  role            Role      @default(PATIENT)
  avatar          String?
  mfaEnabled      Boolean   @default(false)
  mfaSecret       String?   // Encrypted TOTP secret
  mfaBackupCodes  String?   // Encrypted JSON array of hashed backup codes
  mfaVerifiedAt   DateTime? // When MFA was first verified/activated
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  medicalRecords MedicalRecord[]
  sharedRecords  SharedRecord[]
  followUps      FollowUp[]
  notifications  Notification[]
  provider       Provider?
  familyMembers  FamilyMember[] @relation("UserFamilyMembers")
  memberOf       FamilyMember[] @relation("MemberOfFamily")
  organizations  OrganizationMember[]
  linkedPatients Patient[]
}

model MedicalRecord {
  id                 String     @id @default(cuid())
  userId             String
  organizationId     String?
  title              String
  type               RecordType @default(OTHER)
  bodyPart           String?
  facility           String?
  referringPhysician String?
  recordDate         DateTime
  fileUrl            String?
  thumbnailUrl       String?
  fileType           String?
  fileSize           Int?
  notes              String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization  Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  report        Report?
  sharedRecords SharedRecord[]
  followUps     FollowUp[]

  @@index([userId])
  @@index([organizationId])
}

model Report {
  id              String @id @default(cuid())
  medicalRecordId String @unique
  content         String
  summary         String?
  keyFindings     String?
  createdAt       DateTime @default(now())

  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id], onDelete: Cascade)
}

model SharedRecord {
  id              String     @id @default(cuid())
  medicalRecordId String
  sharedByUserId  String
  sharedWithEmail String
  token           String     @unique @default(cuid())
  permission      Permission @default(VIEW)
  expiresAt       DateTime?
  revokedAt       DateTime?
  createdAt       DateTime   @default(now())

  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id], onDelete: Cascade)
  sharedBy      User          @relation(fields: [sharedByUserId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([sharedWithEmail])
}

model FamilyMember {
  id           String   @id @default(cuid())
  userId       String
  memberUserId String
  relationship String
  consentGiven Boolean  @default(false)
  createdAt    DateTime @default(now())

  user   User @relation("UserFamilyMembers", fields: [userId], references: [id], onDelete: Cascade)
  member User @relation("MemberOfFamily", fields: [memberUserId], references: [id], onDelete: Cascade)

  @@unique([userId, memberUserId])
}

model FollowUp {
  id              String         @id @default(cuid())
  userId          String
  organizationId  String?
  medicalRecordId String?
  recommendation  String
  status          FollowUpStatus @default(PENDING)
  dueDate         DateTime?
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization  Organization?  @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  medicalRecord MedicalRecord? @relation(fields: [medicalRecordId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([organizationId])
  @@index([status])
}

model Provider {
  id              String   @id @default(cuid())
  userId          String   @unique
  organizationId  String?
  specialty       String?
  licenseNumber   String?
  facilityName    String?
  facilityAddress String?
  phone           String?
  bio             String?
  createdAt       DateTime @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
}

model Notification {
  id             String   @id @default(cuid())
  userId         String
  organizationId String?
  title          String
  message   String
  type      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([userId, read])
}

model Organization {
  id                  String   @id @default(cuid())
  name                String
  slug                String   @unique
  patientNumberPrefix String   @default("P")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  members          OrganizationMember[]
  features         OrganizationFeature[]
  medicalRecords   MedicalRecord[]
  followUps        FollowUp[]
  notifications    Notification[]
  auditLogs        AuditLog[]
  providers        Provider[]
  patients         Patient[]
  appointments     Appointment[]
  eyeConsultations EyeConsultation[]
  medicalHistories MedicalHistory[]
  labResults       LabResult[]
}

model OrganizationFeature {
  id             String    @id @default(cuid())
  organizationId String
  featureKey     String
  enabled        Boolean   @default(true)
  enabledAt      DateTime  @default(now())
  enabledBy      String?
  disabledAt     DateTime?
  metadata       String?   // JSON string for limits, config, etc.
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, featureKey])
  @@index([organizationId])
  @@index([featureKey])
}

model OrganizationMember {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           OrgRole  @default(RECEPTIONIST)
  createdAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
}

model AuditLog {
  id             String   @id @default(cuid())
  userId         String?
  organizationId String?
  action         String
  entityType     String?
  entityId       String?
  details        String?
  ipAddress      String?
  createdAt      DateTime @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Patient {
  id                String    @id @default(cuid())
  organizationId    String
  linkedUserId      String?
  patientNumber     String
  firstName         String
  lastName          String
  dateOfBirth       DateTime
  gender            Gender
  phone             String?
  email             String?
  address           String?
  emergencyContact  String?
  emergencyPhone    String?
  allergies         String?
  medicalConditions String?
  medications       String?
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  organization     Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  linkedUser       User?              @relation(fields: [linkedUserId], references: [id], onDelete: SetNull)
  appointments     Appointment[]
  eyeConsultations EyeConsultation[]
  medicalHistories MedicalHistory[]
  labResults       LabResult[]

  @@unique([organizationId, patientNumber])
  @@index([organizationId])
  @@index([linkedUserId])
  @@index([lastName, firstName])
}

model Appointment {
  id              String            @id @default(cuid())
  organizationId  String
  patientId       String
  appointmentDate DateTime
  appointmentTime String
  doctor          String
  reason          String?
  status          AppointmentStatus @default(SCHEDULED)
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patient      Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([appointmentDate])
  @@index([status])
}

model EyeConsultation {
  id               String   @id @default(cuid())
  organizationId   String
  patientId        String
  consultationDate DateTime
  doctor           String
  chiefComplaint   String?
  reMovement       String?
  leMovement       String?
  reLids           String?
  leLids           String?
  reGlobe          String?
  leGlobe          String?
  reConjunctiva    String?
  leConjunctiva    String?
  reCornea         String?
  leCornea         String?
  reAc             String?
  leAc             String?
  rePupil          String?
  lePupil          String?
  reIris           String?
  leIris           String?
  reLens           String?
  leLens           String?
  reVrr            String?
  leVrr            String?
  reVcdr           String?
  leVcdr           String?
  reOthers         String?
  leOthers         String?
  diagnosis        String?
  plan             String?
  createdAt        DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patient      Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([consultationDate])
}

model MedicalHistory {
  id                String   @id @default(cuid())
  organizationId    String
  patientId         String
  medicalConditions String?
  medications       String?
  notes             String?
  createdAt         DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patient      Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([createdAt])
}

enum InterpretationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model LabResult {
  id             String   @id @default(cuid())
  organizationId String
  patientId      String
  testName       String
  resultValue    String
  unit           String?
  referenceRange String?
  datePerformed  DateTime
  notes          String?
  createdAt      DateTime @default(now())

  // AI interpretation fields
  interpretationStatus InterpretationStatus?
  interpretationText   String?
  interpretationModel  String?
  confidence           Float?
  riskLevel            String?  // NORMAL, LOW, MODERATE, HIGH, CRITICAL
  recommendations      String?  // JSON array of recommended actions
  interpretedAt        DateTime?
  interpretedBy        String?  // userId who triggered interpretation

  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patient         Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  interpretations LabInterpretation[]

  @@index([organizationId])
  @@index([patientId])
  @@index([datePerformed])
  @@index([interpretationStatus])
}

model LabInterpretation {
  id            String               @id @default(cuid())
  labResultId   String
  provider      String               // openai, anthropic, google
  model         String               // gpt-4o, claude-sonnet-4-6, gemini-2.5-flash, etc.
  status        InterpretationStatus @default(PENDING)
  interpretation String?             // Encrypted full interpretation text
  summary       String?              // Encrypted brief summary
  riskLevel     String?              // NORMAL, LOW, MODERATE, HIGH, CRITICAL
  confidence    Float?               // 0.0 - 1.0
  recommendations String?            // Encrypted JSON array
  tokenUsage    Int?                 // Total tokens used
  latencyMs     Int?                 // Response time in milliseconds
  errorMessage  String?              // If status is FAILED
  requestedBy   String               // userId
  createdAt     DateTime             @default(now())

  labResult LabResult @relation(fields: [labResultId], references: [id], onDelete: Cascade)

  @@index([labResultId])
  @@index([status])
  @@index([createdAt])
}
